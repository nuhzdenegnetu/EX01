# EX05.v2

## Описание

Веб-приложение на Node.js с использованием Express, реализующее RESTful-структуру для управления пользователями и статьями. В проекте используется модульная архитектура с разделением на маршруты, контроллеры, модели и промежуточные обработчики (middlewares). Добавлена поддержка шаблонизаторов для отображения страниц, система аутентификации на основе JWT-токенов, а также подключение к базе данных MongoDB через Mongoose.

## Технологии

- **Node.js** — среда выполнения JavaScript на сервере
- **Express** — фреймворк для построения веб-приложений
- **MongoDB** — нереляционная база данных для хранения данных
- **Mongoose** — ODM для удобной работы с MongoDB из Node.js
- **Pug** — шаблонизатор для генерации HTML-страниц (раздел пользователей и главная)
- **EJS** — шаблонизатор для генерации HTML-страниц (раздел статей)
- **jsonwebtoken** — создание и проверка JWT-токенов для аутентификации
- **dotenv** — загрузка переменных окружения из файла `.env`
- **bcrypt** — хеширование паролей пользователей
- **Middleware** — собственные промежуточные обработчики для логирования, ошибок и авторизации
- **Модульная структура** — разделение кода на роуты, контроллеры, модели

# Функциональность проекта

## Архитектура и структура

- **Модульная организация**
    - Разделение на контроллеры, маршруты, модели и промежуточные обработчики
    - Четкая структура каталогов для каждого типа компонента
    - Использование современного синтаксиса JavaScript (ES modules)

## Система управления темой интерфейса

- **Переключение темы**
    - Маршрут `POST /theme/set-theme` для установки выбранной темы (светлая/темная)
    - Маршрут `GET /theme/get-theme` для получения текущей активной темы
    - Сохранение предпочтений пользователя в сессии
    - Автоматическое применение темы при загрузке страницы

- **Персонализированные настройки**
    - Пользовательские настройки сохраняются между сессиями
    - Адаптивный дизайн с учетом выбранной темы

## Главная страница

- **Домашняя страница**
    - Маршрут `GET /` для доступа к главной странице приложения
    - Отображение основной информации о проекте и навигации
    - Рендеринг через шаблонизатор Pug
    - Интерактивные элементы для перехода к другим разделам
    - Персонализированное приветствие для авторизованных пользователей

- **Доступные функции**
    - Быстрый доступ к основным разделам проекта
    - Переключение между темами интерфейса
    - Демонстрация основных возможностей приложения
    - Информационные блоки и статистика использования

## Управление пользователями

- **Просмотр списка пользователей**
    - Маршрут `GET /users`
    - Отображение пользователей с ID, именем и email
    - Рендеринг через шаблонизатор Pug

- **Профиль пользователя**
    - Маршрут `GET /users/:userId`
    - Отображение детальной информации о конкретном пользователе
    - Включает ID, имя, email и биографию

- **CRUD операции**
    - Просмотр списка пользователей, создание, обновление и удаление пользователей (CRUD)
    - Маршрут `GET /users` для просмотра, `POST /users` для создания, `PUT /users/:userId` для обновления и `DELETE /users/:userId` для удаления
    - Валидация входных данных реализована на уровне контроллеров и моделей
    - Рендеринг через шаблонизатор Pug

## Работа со статьями

- **Функционал для статей**
    - Маршруты через префикс `/articles`
    - Отображение с использованием шаблонизатора EJS

- **CRUD операции**
    - Реализован полный набор операций (CRUD) для статей
    - Маршруты через префикс `/articles`:
      - `GET /articles` — получение списка статей
      - `POST /articles` — создание новой статьи
      - `PUT /articles/:articleId` — обновление существующей статьи
      - `DELETE /articles/:articleId` — удаление статьи
    - Валидация данных и бизнес-логика настроены непосредственно в контроллерах
    - Отображение с использованием шаблонизатора EJS

## Система аутентификации и авторизации

- **Регистрация и вход**
    - Маршрут `POST /auth/register` для создания нового пользователя
    - Маршрут `POST /auth/login` для входа и получения JWT-токена

- **Защита маршрутов**
    - Middleware для проверки валидности токена
    - Доступ к защищенным ресурсам только для авторизованных пользователей

- **Интеграция с Passport.js и express-session**
  - Аутентификация пользователей через различные стратегии
  - Поддержка сессий для удобства пользователей
  - Безопасное хранение данных сессий

- **Защищенный маршрут**
  - Маршрут `/protected` доступен только для авторизованных пользователей
  - Демонстрирует работу системы авторизации на практическом примере
  - Реализован в файле `protected.route.mjs`

- **Выход из системы**
    - Маршрут `GET /auth/logout` для завершения сессии пользователя
    - Удаление JWT-токена на стороне клиента
    - Инвалидация сессии на сервере
    - Перенаправление на страницу входа после успешного выхода
    - Защита от CSRF-атак при выполнении операции выхода

## Техническая реализация

- **Двойная система шаблонизации**
    - Pug для основного сайта и раздела пользователей
    - EJS для раздела статей
    - Автоматическое переключение шаблонизатора на основе URL

- **Middleware-компоненты**
    - Логирование всех входящих запросов
    - Централизованная обработка ошибок
    - Публикация статических файлов
    - Аутентификация и проверка токенов

- **Обработка ошибок**
    - Специальные страницы для 404 ошибок
    - Централизованный обработчик ошибок


## Как запустить проект

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/nuhzdenegnetu/EX01
   ```
2. Перейдите в директорию проекта:
   ```bash
   cd EX01
   ```
3. Установите зависимости:
   ```bash
   npm install
   ```
4. Запустите проект:
   ```bash
   npm start
   ```

## Проверка авторизации и работы с токенами в Postman

### Настройка файла .env

Для правильной работы проекта необходимо создать файл `.env` в корне проекта со следующими переменными:

```bash
MONGO_URI=your_mongodb_connection_string
JWT_SECRET=your_jwt_secret_key
PORT=3000
SESSION_SECRET=your_session_secret_key
```
### Получение токена авторизации
1. Откройте Postman и создайте новый запрос
2. Выберите метод `POST` и введите URL `http://localhost:3000/auth/login`
3. Перейдите во вкладку `Body`, выберите `raw` и формат `JSON`
4. Введите данные для авторизации:
   ```json
   {
       "name": "testuser",
       "email": "user@example.com",
       "password": "password123"
   }
   ```
5. Нажмите `Send` для отправки запроса
6. В ответе вы получите JWT-токен, который будет выглядеть примерно так:
   ```json
   {
       "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
   }
   ```
7. Скопируйте полученный токен для использования в последующих запросах

### Использование токена для доступа к защищенным маршрутам
1. Создайте новый запрос в Postman для защищенного ресурса (например, `GET http://localhost:3000/users`)
2. При корректном токене вы получите доступ к защищенному ресурсу

### Проверка защиты маршрутов
1. Попробуйте отправить запрос к защищенному ресурсу без токена или с недействительным токеном
2. Вы должны получить ошибку 401 (Unauthorized)
3. Добавьте корректный токен в заголовок и повторите запрос
4. Теперь запрос должен пройти успешно и вернуть ожидаемый результат

## Структура проекта

```
📁 EX01/
├── 📁 node_modules/             # Внешние зависимости (автогенерируемая папка)
├── 📁 src/                      # Исходный код проекта
│   ├── 📁 public/               # Публичные ресурсы (стили, скрипты, изображения)
│   │   ├── 📁 css/              # CSS стили
│   │   │        └── style.css
│   │   ├── 📁 js/               # JavaScript-файлы для фронтенда
│   │   │        └── theme.js    # Скрипт для переключения темы
│   │   └── 📁 icon/             # Иконки и изображения
│   │            └── favicon.svg
│   ├── 📁 config/               # Конфигурация приложения
│   │   ├── db.mjs          # Конфигурация подключения к MongoDB
│   │   └── passport.mjs     # Конфигурация Passport.js для аутентификации
│   ├── 📁 controllers/          # Логика обработки запросов
│   │   ├── articles.controller.mjs      # Контроллер статей
│   │   ├── auth.controller.mjs          # Контроллер аутентификации
│   │   ├── index.controller.mjs         # Контроллер главной страницы
│   │   ├── users.controller.mjs         # Контроллер пользователей
│   │   └── ...                          # Другие контроллеры (по мере добавления)
│   ├── 📁 middlewares/          # Промежуточные обработчики
│   │   ├── access.middleware.mjs        # Ограничение доступа
│   │   ├── auth.middleware.mjs          # Проверка JWT-токена
│   │   ├── error.middleware.mjs         # Централизованная обработка ошибок
│   │   ├── access.middleware.mjs       # Ограничение доступа к ресурсам
│   │   └── logging.middleware.mjs       # Логирование запросов
│   ├── 📁 models/               # Модели данных (Mongoose)
│   │   ├── article.model.mjs           # Модель статьи
│   │   ├── user.model.mjs              # Модель пользователя
│   │   ├── authUser.model.mjs                # Модель аутентификации
│   │   ├── fakeUser.model.mjs         # Фейковая модель пользователя для тестов
│   │   └── ...                         # Другие модели (по мере добавления)
│   ├── 📁 routes/               # Маршрутизация API
│   │   ├── articles.route.mjs          # /articles — управление статьями
│   │   ├── auth.route.mjs              # /auth — регистрация и вход пользователей
│   │   ├── index.mjs                   # / — главная страница
│   │   ├── users.route.mjs             # /users — управление пользователями
│   │   ├── protected.route.mjs         # /protected — защищенный маршрут
│   │   ├── theme.route.mjs             # /theme — переключение темы
│   │   └── ...                         # Другие роуты (по мере добавления)
│   └── 📁 views/                # Шаблоны страниц
│      ├── 📁 pug/               # Pug-шаблоны (главная, пользователи, профиль)
│      └── 📁 ejs/               # EJS-шаблоны (статьи)
├── 📄 app.mjs                   # Точка входа приложения, инициализация сервера и БД
├── 📄 package.json              # Метаданные и зависимости
├── 📄 package-lock.json         # Фиксация версий пакетов
└── 📄 README.md                 # Документация
```
`